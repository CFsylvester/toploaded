# Toploaded â€” Dev Guide

Full-stack **Next.js (App Router)** + **Supabase** + **Drizzle ORM**.  
Typed end-to-end, migrations you control, and a clean split between **infra**, **db**, and **app**.

> ðŸ“– **Developer Guide**: See [CONTRIBUTING_README.md](./CONTRIBUTING_README.md) for detailed development guidelines and contribution workflow.

---

## ðŸš€ TL;DR â€” Daily Commands

```bash
# Start dev server
yarn dev

# Change schema â†’ generate SQL migrations
yarn db:gen

# Apply migrations to Supabase
yarn db:migrate

# Refresh TypeScript types from live DB
yarn db:types

# Build for production
yarn build && yarn start
```

---

## Stack

- **Next.js** (TypeScript, `/src`, App Router)
- **Drizzle ORM** + **postgres** driver
- **Supabase** (Auth/Storage/Postgres)
- **direnv** for env loading
- **@supabase/ssr** clients (browser/server/admin)

---

## Project layout

```
/supabase
  /types/database.ts        # generated by CLI (do not edit)
/src
  /app                      # routes
  /db
    index.ts                # drizzle client
    /schema                 # pgTable files + relations + barrel
  /lib/supabase             # browser.ts, server.ts, admin.ts
  /types/db.ts              # re-exports Database type
/scripts
  migrate.ts                # runs drizzle SQL migrations
/drizzle                    # generated SQL migrations
/docs                       # documentation (optional)
```

---

## Prereqs

- Node 20+
- Yarn
- Supabase project (URL, anon key, service role, DB URL)
- direnv: `brew install direnv` â†’ add hook to your shell (see direnv docs)
- Supabase CLI: `brew install supabase/tap/supabase` (or `npm i -g supabase`)

---

## Environment variables (direnv)

Create **`.envrc`** at repo root and allow it:

```sh
# Supabase (public)
export NEXT_PUBLIC_SUPABASE_URL="https://<project>.supabase.co"
export NEXT_PUBLIC_SUPABASE_ANON_KEY="<anon>"

# Supabase (server-only)
export SUPABASE_SERVICE_ROLE_KEY="<service-role>"

# Database
export DATABASE_URL="postgres://postgres:<password>@<host>:5432/postgres?sslmode=require"

# Supabase project reference
export SUPABASE_PROJECT_REF="<project-ref>"
```

Then run:

```bash
direnv allow
```

---

## Install & run

```bash
yarn install
yarn dev
```

App runs at [http://localhost:3000](http://localhost:3000).

---

## Database workflow

### 1. Change schema

Edit files under `src/db/schema/`.

### 2. Generate SQL migrations

```bash
yarn db:gen
```

This creates `.sql` files in `/drizzle`.

### 3. Apply migrations to Supabase

```bash
yarn db:migrate
```

This runs the `.sql` files against your Supabase Postgres.

### 4. Update TypeScript types

```bash
yarn db:types
```

This refreshes `supabase/types/database.ts` with types from your live DB.

---

## When to do what?

- **Added/changed a table/column** â†’ `yarn db:gen && yarn db:migrate && yarn db:types`
- **Pulled project fresh** â†’ `yarn install && yarn db:migrate && yarn db:types && yarn dev`
- **New teammate/CI** â†’ make sure `.envrc` has creds, run same commands above

---

## Supabase clients

- `src/lib/supabase/browser.ts` â†’ use inside **client components**
- `src/lib/supabase/server.ts` â†’ use inside **server components / route handlers**
- `src/lib/supabase/admin.ts` â†’ server-only tasks (cron, webhooks)

---

## Running in production

```bash
yarn build
yarn start
```

- `yarn build` â†’ compiles Next.js into `.next`
- `yarn start` â†’ runs the optimized production server

---

## Deploy

1. Push code to GitHub.
2. Set env vars on Vercel (same as `.envrc` but without `export`).
3. Vercel will run `yarn build` and host at your domain.

---

## ðŸ—‚ï¸ Database Schema

This project implements a **multi-tenant trading card marketplace** with the following key domains:

### **Core Entities**

- **Multi-tenancy**: `tenants`, `tenant_domains`, `users`, `roles`, `user_roles`
- **Cards & Variants**: `cards`, `card_variants`, `card_prints`, `graded_cards`
- **Pricing**: `card_prices`, `price_snapshots`
- **Inventory**: `inventory_items`, `barcodes`, `storage_locations`
- **Orders & Sales**: `orders`, `order_items`, `listings`, `payments`, `shipments`, `addresses`
- **System**: `audits`, `games`, `sets`

### **Key Relationships**

- A **tenant** owns cards, sets, users, inventory, and orders
- A **set** belongs to a `game` and a `tenant`
- A **card** belongs to a `set` and `tenant`
- **Inventory items** may reference a `card_print` OR a `graded_card`
- **Listings** sell inventory items
- **Orders** contain many `order_items` with payments and shipments

### **Multi-tenancy Pattern**

Everything ties back to `tenant_id`. Always scope queries by tenant for security and data isolation.

> ðŸ“– **Detailed Schema Guide**: See [SCHEMA_README.md](./SCHEMA_README.md) for complete database documentation, diagrams, and workflow examples.
